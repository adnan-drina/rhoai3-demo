---
description: Use for any work in gitops/ or Kustomize files. Enforce GitOps + Kustomize best practices and reproducible steps.
globs: gitops/**,**/kustomization.yaml,**/kustomization.yml
alwaysApply: false
---

# GitOps & Kustomize Rules

## Golden rule
Every demo step must be reproducible from the `gitops/` folder (either via `deploy.sh` or by following the step README).

## Repository layout (this project)

This repository uses a **split layout** separating manifests from deployment documentation:

```
rhoai3-demo/
├── gitops/                              # Kustomize manifests (GitOps source of truth)
│   ├── argocd/
│   │   └── app-of-apps/                 # Argo CD Application definitions
│   │       ├── kustomization.yaml
│   │       ├── step-01-gpu-and-prereq.yaml
│   │       ├── step-02-rhoai.yaml
│   │       └── ...
│   │
│   ├── step-01-gpu-and-prereq/          # Step manifests
│   │   ├── base/                        # Environment-agnostic resources
│   │   │   ├── kustomization.yaml
│   │   │   ├── nfd/
│   │   │   ├── gpu-operator/
│   │   │   └── ...
│   │   └── overlays/                    # Environment-specific deltas
│   │       └── aws/
│   │           ├── kustomization.yaml
│   │           └── machinesets/
│   │
│   ├── step-02-rhoai/
│   │   └── base/
│   │
│   ├── step-03-private-ai/
│   │   ├── base/
│   │   └── gpu-as-a-service-demo/       # Demo overlay (optional apply)
│   │
│   ├── step-04-model-registry/
│   │   └── base/
│   │
│   └── step-05-llm-on-vllm/
│       └── base/
│
├── steps/                               # Deployment documentation (per-step)
│   ├── step-01-gpu-and-prereq/
│   │   ├── deploy.sh                    # One-shot deployment script
│   │   └── README.md                    # Full documentation
│   ├── step-02-rhoai/
│   │   ├── deploy.sh
│   │   └── README.md
│   └── ...
│
├── scripts/                             # Shared utilities
│   ├── bootstrap.sh                     # Initial GitOps setup
│   └── lib.sh                           # Common shell functions
│
├── env.example                          # Environment template
└── README.md                            # Project overview
```

## Kustomize structure rules
- Prefer `base/` + `overlays/<env-or-purpose>/` within each step.
- Keep `base/` environment-agnostic; put environment/step deltas in overlays.
- Avoid duplicating full resources across overlays—use patches.
- Prefer `resources:` + `patches:` (strategic merge or JSON6902) with minimal diffs.
- Use consistent naming and labels to make `oc get` and `oc diff` readable.

## Naming conventions
- Step folders: `step-XX-descriptive-name/` (e.g., `step-01-gpu-and-prereq`)
- Overlays: `overlays/<purpose>/` (e.g., `overlays/aws/`, `overlays/demo/`)
- Operator folders: group by operator name (e.g., `nfd/`, `gpu-operator/`, `rhoai-operator/`)

## Output hygiene
- Never require manual, out-of-band edits to cluster state (except secrets created per the secrets rule).
- If a resource must be created by CLI (non-secret), it should still be described in README with rationale and verification.

## Validation commands to include in README (as applicable)
- `kustomize build <path> | oc apply --dry-run=server -f -`
- `kustomize build <path> | oc diff -f -`
- `kustomize build <path> | oc apply -f -`

## Argo CD integration
- Each step has an Argo CD Application in `gitops/argocd/app-of-apps/`
- Applications point to `gitops/step-XX-name/base/` by default
- Use `deploy.sh` scripts to apply the Argo CD Application and wait for sync
