# Grafana Deployment for vLLM Model Metrics
# ============================================================================
# Deploys Grafana 10.x with preconfigured datasources and dashboards.
#
# Architecture:
#   - Init container reads SA token and injects it into datasource config
#   - Main container runs Grafana with provisioned datasources and dashboards
#   - Anonymous access enabled for demo simplicity (Admin role)
#
# Dashboards are provisioned from ConfigMaps mounted at /var/lib/grafana/dashboards
# Datasources are provisioned from ConfigMap at /etc/grafana/provisioning/datasources
#
# Ref: https://grafana.com/docs/grafana/latest/setup-grafana/configure-docker/
# ============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: private-ai
  labels:
    app: grafana
    app.kubernetes.io/part-of: step-07-model-performance-metrics
  annotations:
    argocd.argoproj.io/sync-wave: "5"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
        app.kubernetes.io/part-of: step-07-model-performance-metrics
    spec:
      serviceAccountName: grafana-sa
      
      # Init container to inject SA token into datasource configuration
      initContainers:
        - name: inject-token
          image: registry.access.redhat.com/ubi9/ubi-minimal:latest
          command:
            - /bin/sh
            - -c
            - |
              # Read the ServiceAccount token
              TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
              
              # Read the datasource template and replace placeholder with actual token
              sed "s/PLACEHOLDER/${TOKEN}/g" /etc/grafana-template/datasources.yaml > /etc/grafana/provisioning/datasources/datasources.yaml
              
              echo "Token injected into datasource configuration"
          volumeMounts:
            - name: datasource-template
              mountPath: /etc/grafana-template
            - name: datasource-provisioning
              mountPath: /etc/grafana/provisioning/datasources
      
      containers:
        - name: grafana
          image: docker.io/grafana/grafana:10.4.1
          ports:
            - containerPort: 3000
              name: http
              protocol: TCP
          env:
            # Anonymous access for demo (no login required)
            - name: GF_AUTH_ANONYMOUS_ENABLED
              value: "true"
            - name: GF_AUTH_ANONYMOUS_ORG_ROLE
              value: "Admin"
            - name: GF_AUTH_DISABLE_LOGIN_FORM
              value: "true"
            # Dashboard provisioning
            - name: GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH
              value: "/var/lib/grafana/dashboards/vllm-overview.json"
            # Logging
            - name: GF_LOG_LEVEL
              value: "info"
            # Server settings
            - name: GF_SERVER_ROOT_URL
              value: "%(protocol)s://%(domain)s/"
          volumeMounts:
            # Datasource provisioning (with injected token)
            - name: datasource-provisioning
              mountPath: /etc/grafana/provisioning/datasources
            # Dashboard provisioning configuration
            - name: dashboard-provisioning
              mountPath: /etc/grafana/provisioning/dashboards
            # Dashboard JSON files
            - name: dashboards
              mountPath: /var/lib/grafana/dashboards
            # Persistent storage for Grafana data
            - name: grafana-data
              mountPath: /var/lib/grafana
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          livenessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 10
            periodSeconds: 5
      
      volumes:
        # Datasource template (before token injection)
        - name: datasource-template
          configMap:
            name: grafana-datasources
        # Datasource provisioning (after token injection by init container)
        - name: datasource-provisioning
          emptyDir: {}
        # Dashboard provisioning configuration
        - name: dashboard-provisioning
          configMap:
            name: grafana-dashboard-provisioner
        # Dashboard JSON files
        - name: dashboards
          configMap:
            name: grafana-dashboards
        # Grafana data directory
        - name: grafana-data
          emptyDir: {}

