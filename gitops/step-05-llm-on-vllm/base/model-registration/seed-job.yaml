# =============================================================================
# Step 05: Enterprise Model Portfolio Registration
# =============================================================================
# Registers the complete model portfolio for the GPU-as-a-Service demo.
#
# ACTIVE MODELS (minReplicas: 1):
#   1. Mistral-3-BF16    â†’ 4-GPU, S3 storage (primary load)
#   2. Mistral-3-INT4    â†’ 1-GPU, OCI ModelCar (secondary load)
#
# QUEUED MODELS (minReplicas: 0):
#   3. Devstral-2        â†’ 4-GPU, S3 storage (agentic)
#   4. GPT-OSS-20B       â†’ 4-GPU, S3 storage (high-reasoning)
#   5. Granite-8B-Agent  â†’ 1-GPU, S3 storage (tool-calling)
#
# Demo Scenarios:
#   1. Resource Handover: Swap BF16 for Devstral
#   2. Efficiency Story: Trade 1x 4-GPU for 4x 1-GPU specialists
#   3. Model Portfolio: Show all 5 Red Hat Validated models
#
# Ref: https://docs.redhat.com/en/documentation/red_hat_openshift_ai_self-managed/3.0/html-single/working_with_model_registries/index
# =============================================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: llm-model-registration
  namespace: rhoai-model-registries
  labels:
    app: llm-model-registration
  annotations:
    argocd.argoproj.io/sync-wave: "1"
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  backoffLimit: 5
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app: llm-model-registration
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: register
          image: quay.io/curl/curl:latest
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
          env:
            - name: REGISTRY_URL
              value: "http://private-ai-registry-internal.rhoai-model-registries.svc:8080"
            # S3 Configuration for MinIO
            - name: S3_ENDPOINT
              value: "http://minio.minio-storage.svc:9000"
            - name: S3_BUCKET
              value: "models"
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘  Step 05: LLM Model Registration (S3 Handshake)              â•‘"
              echo "â•‘  Registry stores metadata â†’ MinIO stores weights             â•‘"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              
              API_BASE="${REGISTRY_URL}/api/model_registry/v1alpha3"
              
              echo "Waiting for Model Registry API..."
              for i in $(seq 1 30); do
                if curl -sf "${API_BASE}/registered_models" > /dev/null 2>&1; then
                  echo "âœ“ Model Registry API is ready!"
                  break
                fi
                echo "  Attempt $i/30 - waiting..."
                sleep 10
              done
              
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              # Function to register a model with S3 URI
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              register_model() {
                local MODEL_NAME="$1"
                local MODEL_DESC="$2"
                local MODEL_TAGS="$3"
                local VERSION_NAME="$4"
                local VERSION_META="$5"
                local S3_PATH="$6"
                local SOURCE_NAME="$7"
                local MODEL_FORMAT="$8"
                
                # Construct full S3 URI
                local ARTIFACT_URI="s3://${S3_BUCKET}/${S3_PATH}"
                
                echo ""
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "Registering: ${MODEL_NAME}"
                echo "  S3 URI: ${ARTIFACT_URI}"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                
                if curl -sf "${API_BASE}/registered_models" | grep -q "\"name\":\"${MODEL_NAME}\""; then
                  echo "âœ“ Model '${MODEL_NAME}' already exists - skipping"
                  return 0
                fi
                
                # Create RegisteredModel
                MODEL_RESP=$(curl -sf -X POST "${API_BASE}/registered_models" \
                  -H "Content-Type: application/json" \
                  -d "{
                    \"name\": \"${MODEL_NAME}\",
                    \"description\": \"${MODEL_DESC}\",
                    \"owner\": \"ai-admin\",
                    \"customProperties\": ${MODEL_TAGS}
                  }")
                MODEL_ID=$(echo "$MODEL_RESP" | sed 's/.*"id":"\([^"]*\)".*/\1/' | head -1)
                echo "  Created RegisteredModel ID: ${MODEL_ID}"
                
                # Create ModelVersion
                VERSION_RESP=$(curl -sf -X POST "${API_BASE}/model_versions" \
                  -H "Content-Type: application/json" \
                  -d "{
                    \"name\": \"${VERSION_NAME}\",
                    \"description\": \"Production-ready version for RHOAI 3.0\",
                    \"author\": \"ai-admin\",
                    \"registeredModelId\": \"${MODEL_ID}\",
                    \"customProperties\": ${VERSION_META}
                  }")
                VERSION_ID=$(echo "$VERSION_RESP" | sed 's/.*"id":"\([^"]*\)".*/\1/' | head -1)
                echo "  Created ModelVersion ID: ${VERSION_ID}"
                
                # Create ModelArtifact with S3 metadata (Official RHOAI 3.0 format)
                # This enables the "Deploy from Registry" flow in GenAI Studio
                curl -sf -X POST "${API_BASE}/model_versions/${VERSION_ID}/artifacts" \
                  -H "Content-Type: application/json" \
                  -d "{
                    \"name\": \"${VERSION_NAME}\",
                    \"uri\": \"${ARTIFACT_URI}\",
                    \"artifactType\": \"model-artifact\",
                    \"modelFormatName\": \"${MODEL_FORMAT}\",
                    \"customProperties\": {
                      \"s3_endpoint\": {\"metadataType\": \"MetadataStringValue\", \"string_value\": \"${S3_ENDPOINT}\"},
                      \"s3_bucket\": {\"metadataType\": \"MetadataStringValue\", \"string_value\": \"${S3_BUCKET}\"},
                      \"format\": {\"metadataType\": \"MetadataStringValue\", \"string_value\": \"safetensors\"},
                      \"source_model\": {\"metadataType\": \"MetadataStringValue\", \"string_value\": \"${SOURCE_NAME}\"}
                    }
                  }" > /dev/null
                
                echo "âœ“ Registered: ${MODEL_NAME} â†’ ${ARTIFACT_URI}"
              }
              
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              # Model 1: Mistral-3-BF16 (4-GPU, Primary Load)
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              register_model \
                "Mistral-3-BF16" \
                "Mistral Small 24B Instruct - BF16 Full Precision. Primary 4-GPU model for high-throughput production." \
                '{"mistral":{"metadataType":"MetadataStringValue","string_value":""},"bf16":{"metadataType":"MetadataStringValue","string_value":""},"validated":{"metadataType":"MetadataStringValue","string_value":""},"vllm":{"metadataType":"MetadataStringValue","string_value":""},"production":{"metadataType":"MetadataStringValue","string_value":""}}' \
                "v1.0-BF16" \
                '{"License":{"metadataType":"MetadataStringValue","string_value":"Apache-2.0"},"Provider":{"metadataType":"MetadataStringValue","string_value":"Mistral AI"},"precision":{"metadataType":"MetadataStringValue","string_value":"bfloat16"},"gpu_requirement":{"metadataType":"MetadataStringValue","string_value":"4x NVIDIA L4 (g6.12xlarge)"},"tensor_parallel":{"metadataType":"MetadataStringValue","string_value":"4"},"context_length":{"metadataType":"MetadataStringValue","string_value":"32768"},"demo_role":{"metadataType":"MetadataStringValue","string_value":"Primary Load"}}' \
                "mistral-small-24b/" \
                "mistralai/Mistral-Small-24B-Instruct-2501" \
                "vLLM"
              
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              # Model 2: Mistral-3-INT4 (1-GPU, Secondary Load)
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              register_model \
                "Mistral-3-INT4" \
                "Mistral Small 24B Instruct - INT4 W4A16 quantized by Neural Magic. Cost-efficient 1-GPU deployment." \
                '{"mistral":{"metadataType":"MetadataStringValue","string_value":""},"int4":{"metadataType":"MetadataStringValue","string_value":""},"w4a16":{"metadataType":"MetadataStringValue","string_value":""},"neural-magic":{"metadataType":"MetadataStringValue","string_value":""},"modelcar":{"metadataType":"MetadataStringValue","string_value":""}}' \
                "v1.5-INT4-W4A16" \
                '{"License":{"metadataType":"MetadataStringValue","string_value":"Apache-2.0"},"Provider":{"metadataType":"MetadataStringValue","string_value":"Neural Magic / Red Hat"},"quantization":{"metadataType":"MetadataStringValue","string_value":"int4-w4a16"},"bits":{"metadataType":"MetadataStringValue","string_value":"4"},"accuracy_recovery":{"metadataType":"MetadataStringValue","string_value":"98.9%"},"gpu_requirement":{"metadataType":"MetadataStringValue","string_value":"1x NVIDIA L4 (g6.4xlarge)"},"demo_role":{"metadataType":"MetadataStringValue","string_value":"Secondary Load"}}' \
                "oci://registry.redhat.io/rhelai1/modelcar-mistral-small-24b-instruct-2501-quantized-w4a16:1.5" \
                "neuralmagic/Mistral-Small-24B-Instruct-2501-quantized.w4a16" \
                "vLLM"
              
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              # Model 3: Devstral-2 (4-GPU, Queued Asset)
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              register_model \
                "Devstral-2" \
                "Devstral 2 24B - Agentic model optimized for tool use and function calling. The 'waiting' model in the Resource Handover demo." \
                '{"mistral":{"metadataType":"MetadataStringValue","string_value":""},"devstral":{"metadataType":"MetadataStringValue","string_value":""},"agentic":{"metadataType":"MetadataStringValue","string_value":""},"tool-use":{"metadataType":"MetadataStringValue","string_value":""},"vllm":{"metadataType":"MetadataStringValue","string_value":""}}' \
                "v1.0-Agentic" \
                '{"License":{"metadataType":"MetadataStringValue","string_value":"Apache-2.0"},"Provider":{"metadataType":"MetadataStringValue","string_value":"Mistral AI"},"precision":{"metadataType":"MetadataStringValue","string_value":"bfloat16"},"gpu_requirement":{"metadataType":"MetadataStringValue","string_value":"4x NVIDIA L4 (g6.12xlarge)"},"tensor_parallel":{"metadataType":"MetadataStringValue","string_value":"4"},"features":{"metadataType":"MetadataStringValue","string_value":"tool-calling,agentic"},"demo_role":{"metadataType":"MetadataStringValue","string_value":"Queued Asset"}}' \
                "mistral-small-24b/" \
                "mistralai/Mistral-Small-24B-Instruct-2501" \
                "vLLM"
              
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              # Model 4: GPT-OSS-20B (4-GPU, High-Reasoning) - October 2025 Collection
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              register_model \
                "GPT-OSS-20B" \
                "GPT-OSS-20B - Red Hat Validated enterprise reasoning model (October 2025). OpenAI-alternative for complex instruction following." \
                '{"gpt-oss":{"metadataType":"MetadataStringValue","string_value":""},"redhat-validated":{"metadataType":"MetadataStringValue","string_value":""},"oct-2025":{"metadataType":"MetadataStringValue","string_value":""},"reasoning":{"metadataType":"MetadataStringValue","string_value":""},"vllm":{"metadataType":"MetadataStringValue","string_value":""}}' \
                "v1.0-BF16-Oct2025" \
                '{"License":{"metadataType":"MetadataStringValue","string_value":"Apache-2.0"},"Provider":{"metadataType":"MetadataStringValue","string_value":"RedHatAI"},"precision":{"metadataType":"MetadataStringValue","string_value":"bfloat16"},"collection":{"metadataType":"MetadataStringValue","string_value":"October 2025"},"gpu_requirement":{"metadataType":"MetadataStringValue","string_value":"4x NVIDIA L4 (g6.12xlarge)"},"tensor_parallel":{"metadataType":"MetadataStringValue","string_value":"4"},"context_length":{"metadataType":"MetadataStringValue","string_value":"8192"},"demo_role":{"metadataType":"MetadataStringValue","string_value":"High-Reasoning"}}' \
                "gpt-oss-20b/" \
                "RedHatAI/gpt-oss-20b" \
                "vLLM"
              
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              # Model 5: Granite-3.1-8B-Agent (1-GPU, Tool-Calling) - May 2025 Collection
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              register_model \
                "Granite-3.1-8B-Agent" \
                "Granite 3.1 8B Instruct FP8 - The Agentic Core. Red Hat flagship for tool-calling, function-calling, and RAG workflows." \
                '{"granite":{"metadataType":"MetadataStringValue","string_value":""},"redhat-validated":{"metadataType":"MetadataStringValue","string_value":""},"may-2025":{"metadataType":"MetadataStringValue","string_value":""},"agentic":{"metadataType":"MetadataStringValue","string_value":""},"fp8":{"metadataType":"MetadataStringValue","string_value":""},"tool-calling":{"metadataType":"MetadataStringValue","string_value":""}}' \
                "v3.1-FP8-May2025" \
                '{"License":{"metadataType":"MetadataStringValue","string_value":"Apache-2.0"},"Provider":{"metadataType":"MetadataStringValue","string_value":"IBM / Red Hat"},"quantization":{"metadataType":"MetadataStringValue","string_value":"fp8-dynamic"},"collection":{"metadataType":"MetadataStringValue","string_value":"May 2025"},"gpu_requirement":{"metadataType":"MetadataStringValue","string_value":"1x NVIDIA L4 (g6.4xlarge)"},"context_length":{"metadataType":"MetadataStringValue","string_value":"16384"},"features":{"metadataType":"MetadataStringValue","string_value":"tool-calling,rag,agentic"},"demo_role":{"metadataType":"MetadataStringValue","string_value":"Small but Mighty"}}' \
                "granite-3.1-8b-instruct-fp8/" \
                "RedHatAI/granite-3.1-8b-instruct-FP8-dynamic" \
                "vLLM"
              
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "âœ“ Enterprise Model Portfolio Registered (5 Models)"
              echo ""
              echo "  ğŸ“Š ACTIVE (5/5 GPUs saturated):"
              echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
              echo "  â”‚  mistral-3-bf16   â”‚ 4 GPUs â”‚ ğŸŸ¢ ON  â”‚ Primary Load          â”‚"
              echo "  â”‚  mistral-3-int4   â”‚ 1 GPU  â”‚ ğŸŸ¢ ON  â”‚ Secondary Load        â”‚"
              echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
              echo ""
              echo "  ğŸ“‹ QUEUED (Ready to activate):"
              echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
              echo "  â”‚  devstral-2       â”‚ 4 GPUs â”‚ â¸ï¸ OFF â”‚ Agentic               â”‚"
              echo "  â”‚  gpt-oss-20b      â”‚ 4 GPUs â”‚ â¸ï¸ OFF â”‚ High-Reasoning        â”‚"
              echo "  â”‚  granite-8b-agent â”‚ 1 GPU  â”‚ â¸ï¸ OFF â”‚ Tool-Calling          â”‚"
              echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
              echo ""
              echo "  ğŸ¬ Demo Scenarios:"
              echo "    1. Resource Handover: Swap mistral-3-bf16 â†’ devstral-2"
              echo "    2. Efficiency Story: 1x 4-GPU â†’ 4x 1-GPU specialists"
              echo "    3. Model Portfolio: Show all 5 Red Hat Validated models"
              echo ""
              echo "  Total Potential: 14 GPUs | Quota Limit: 5 GPUs"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
